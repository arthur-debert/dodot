#!/usr/bin/env bash
set -euo pipefail

# Build output directory
BUILD_DIR="dist/build"
BIN_DIR="${BUILD_DIR}/bin"
MAN_DIR="${BUILD_DIR}/man/man1"

# Create man directory
mkdir -p "${MAN_DIR}"

# Find the dodot binary - prefer our build dir, then current directory
if [ -f "${BIN_DIR}/dodot" ]; then
    DODOT_BIN="${BIN_DIR}/dodot"
elif [ -f "./dodot" ]; then
    DODOT_BIN="./dodot"
else
    # Build it if not found
    echo "Building dodot..."
    ./scripts/build
    DODOT_BIN="${BIN_DIR}/dodot"
fi

# Generate man page
echo "Generating man page..."
"${DODOT_BIN}" man > "${MAN_DIR}/dodot.1" 2>/dev/null || {
    echo "Note: 'man' subcommand not implemented yet"
    echo "Creating placeholder man page..."
    cat > "${MAN_DIR}/dodot.1" << EOF
.TH DODOT 1 "$(date +"%B %Y")" "dodot manual"
.SH NAME
dodot \- A stateless dotfiles manager
.SH SYNOPSIS
.B dodot
[\fIOPTIONS\fR] [\fICOMMAND\fR]
.SH DESCRIPTION
Description of your CLI tool
.SH OPTIONS
.TP
.BR \-h ", " \-\-help
Show help message
.TP
.BR \-v ", " \-\-version
Show version information
.SH AUTHORS
Arthur Debert <arthur@debert.xyz>
.SH COPYRIGHT
Copyright (C) 2024 Arthur Debert
EOF
}

# Compress the man page
if [ -f "${MAN_DIR}/dodot.1" ]; then
    gzip -f "${MAN_DIR}/dodot.1"
    echo "✅ Man page generated in ${MAN_DIR}/dodot.1.gz"
    
    # For backwards compatibility, also copy to old location
    mkdir -p man/man1
    cp "${MAN_DIR}/dodot.1.gz" man/man1/
    echo "✅ Also copied to man/man1/ for backwards compatibility"
else
    echo "❌ Failed to generate man page"
    exit 1
fi