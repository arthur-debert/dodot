name: Docker Integration Tests

# Run on demand only - not on every commit
on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

jobs:
  docker-integration:
    name: Run Docker Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Need full history for version info
          fetch-depth: 0
      
      - name: Build Docker test image
        run: |
          echo "Building Docker test image..."
          cd test-environment
          docker build -t dodot-test .
      
      - name: Run Docker integration tests
        id: run-tests
        run: |
          echo "Running Docker integration tests..."
          cd test-environment
          
          # Run the tests and capture output
          set +e  # Don't exit on failure, we want to capture the output
          OUTPUT=$(./docker-run.sh 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Print the full output for debugging
          echo "$OUTPUT"
          
          # Extract stage statuses
          SETUP_STATUS=$(echo "$OUTPUT" | grep -E "^STAGE SETUP:" | tail -1 | cut -d' ' -f3)
          TEST_STATUS=$(echo "$OUTPUT" | grep -E "^STAGE TEST:" | tail -1 | cut -d' ' -f3)
          REPORT_STATUS=$(echo "$OUTPUT" | grep -E "^STAGE REPORT:" | tail -1 | cut -d' ' -f3)
          
          echo "=== Extracted Status ==="
          echo "Setup: $SETUP_STATUS"
          echo "Test: $SETUP_STATUS"
          echo "Report: $REPORT_STATUS"
          
          # Set outputs for other steps
          echo "setup_status=$SETUP_STATUS" >> $GITHUB_OUTPUT
          echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
          echo "report_status=$REPORT_STATUS" >> $GITHUB_OUTPUT
          
          # For now, we only care about setup success
          if [ "$SETUP_STATUS" = "SUCCESS" ]; then
            echo "✅ Setup phase succeeded - workflow passes"
            exit 0
          else
            echo "❌ Setup phase failed - workflow fails"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Docker Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ steps.run-tests.outputs.setup_status || 'UNKNOWN' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ steps.run-tests.outputs.test_status || 'UNKNOWN' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Report | ${{ steps.run-tests.outputs.report_status || 'UNKNOWN' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current success criteria:** Setup phase must succeed" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-results
          path: |
            test-environment/test-results/
            bin/dodot-container-linux
          retention-days: 7
          if-no-files-found: ignore